<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPT DocMaster</title>
  <!-- Your custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <!-- Font Awesome Free -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
  />
</head>
<body>
  <header>
    <div style="display:flex; align-items:center;">
      <h1>GPT DocMaster</h1>
      <span id="watchStatus">Connecting…</span>
    </div>
    <div>
      <button id="gridBtn" disabled>Grid</button>
      <button id="listBtn">List</button>
    </div>
  </header>

  <input
    id="searchInput"
    placeholder="🔍 Search documents..."
    autofocus
  />

  <div id="status">Loading documents…</div>
  <div class="doc-list" id="docList"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const docListEl   = document.getElementById("docList");
      const statusEl    = document.getElementById("status");
      const gridBtn     = document.getElementById("gridBtn");
      const listBtn     = document.getElementById("listBtn");
      const watchStatus = document.getElementById("watchStatus");
      const searchInput = document.getElementById("searchInput");

      // Toggle views
      gridBtn.addEventListener("click", () => {
        docListEl.classList.remove("list-view");
        gridBtn.disabled = true;
        listBtn.disabled = false;
      });
      listBtn.addEventListener("click", () => {
        docListEl.classList.add("list-view");
        gridBtn.disabled = false;
        listBtn.disabled = true;
      });

      // Render a document card
      function addCard(doc) {
        const card = document.createElement("div");
        card.className = "doc-card";

        // Determine file extension
        const ext = doc.filename.split('.').pop().toLowerCase();

        // Show icon for TXT/DOCX, real thumbnail for others
        if (ext === 'txt' || ext === 'docx') {
          const icon = document.createElement("i");
          icon.className = ext === 'txt'
            ? "fas fa-file-lines doc-icon"
            : "fas fa-file-word doc-icon";
          card.appendChild(icon);

        } else if (doc.thumbnail_url) {
          const img = document.createElement("img");
          img.src = doc.thumbnail_url;
          img.alt = doc.filename;
          card.appendChild(img);
        } else {
          const placeholder = document.createElement("div");
          placeholder.textContent = "(no thumbnail)";
          placeholder.style.height = "150px";
          placeholder.style.display = "flex";
          placeholder.style.alignItems = "center";
          placeholder.style.justifyContent = "center";
          placeholder.style.color = "#666";
          card.appendChild(placeholder);
        }

        // Title
        const titleEl = document.createElement("div");
        titleEl.className = "doc-title";
        titleEl.textContent = doc.title || doc.filename;
        card.appendChild(titleEl);

        // Summary placeholder
        const summaryEl = document.createElement("div");
        summaryEl.className = "doc-summary";
        summaryEl.textContent = "Summary: No summary available.";
        card.appendChild(summaryEl);

        // Metadata: uploaded, modified, size
        const metaEl = document.createElement("div");
        metaEl.className = "doc-meta";
        metaEl.innerHTML = `
          <span>Uploaded: ${new Date(doc.added_at).toLocaleString()}</span>
          <span>Modified: ${new Date(doc.updated_at).toLocaleString()}</span>
          <span>Size: N/A</span>
        `;
        card.appendChild(metaEl);

        // Actions: View / Download
        const actionsEl = document.createElement("div");
        actionsEl.className = "doc-actions";
        actionsEl.innerHTML = `
          <button class="btn-view">View</button>
          <button class="btn-download">Download</button>
        `;
        card.appendChild(actionsEl);

        docListEl.appendChild(card);
      }

      // Load documents from API
      async function loadDocs(q = "") {
        statusEl.textContent = "Loading documents…";
        docListEl.innerHTML = "";
        try {
          const res  = await fetch(`/api/docs?q=${encodeURIComponent(q)}`);
          const docs = await res.json();
          if (!docs.length) {
            statusEl.textContent = q
              ? "No documents match your search."
              : "No documents found.";
            return;
          }
          statusEl.textContent = "";
          docs.forEach(addCard);
        } catch (err) {
          statusEl.textContent = "Error loading documents.";
          console.error(err);
        }
      }

      // Search box wiring
      searchInput.addEventListener("input", e => {
        loadDocs(e.target.value.trim());
      });

      // Initial fetch
      loadDocs();

      // SSE live updates
      const evt = new EventSource("/stream");
      evt.onopen  = () => watchStatus.textContent = "Watching folder";
      evt.onerror = () => {
        watchStatus.textContent = "Watcher disconnected";
        evt.close();
      };
      evt.onmessage = e => {
        const msg = JSON.parse(e.data);
        if (msg.action === "created" || msg.action === "deleted") {
          loadDocs(searchInput.value.trim());
        }
      };
    });
  </script>
</body>
</html>
